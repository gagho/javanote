# 高性能MYSQL（拉勾教育）

## mysql体系结构与存储引擎

mysql的体系结构由client Connectors层，mysql server层及存储引擎组成

### client Connectors层

处理客户端的连接请求

### mysql server层

主要包含Connection Pool、Service & utilities、SQL interface、Parser解析器、Optimizer 查询优化器、Caches 缓存等模块

+ Connection Pool，连接池，负责处理存储数据库与客户端创建的连接，也包含了身份校验及安全管理
+ Service & utilities ，公共服务部分，包括了恢复备份、安全管理、集群管理和公有工具
+ SQL interface，数据接口部分，负责接收客户端发送的sql
+ Parser解析器，对sql语句进行语法解析生成解析树
+ Optimizer 查询优化器，根据解析树生成执行计划，选择合适的索引，执行sql并与存储引擎交互
+ Caches 缓存，存储引擎的缓存部分

### 存储引擎

存储引擎包括 MyISAM、InnoDB，以及支持归档的 Archive 和内存的 Memory 等

## msql事务与锁机制

事务：事务是指作为单个逻辑工作单元执行的一系列操作，这些操作要么全做，要么全不做，是一个不可分割的工作单元。

事务的四个特性：ACID：原子性、一致性、隔离性和持久性。

+ 原子性：事务的所有操作要么全部完成，要么全部回滚，不会中断在某个中间环节
+ 一致性：事务开始前和结束后，数据库的完整性限制不能被破坏
+ 隔离性：多个事务并发访问数据库中的一段数据时所表现的相互关系
+ 持久性：事务完成后，事务做的修改进行持久化保存不会丢失

### 一致性

一致性包含两部分内容，约束一致性和数据一致性，数据一致性通过其他的三个特性进行保证

### 原子性

mysql通过WAL（Write Ahead Log）技术实现。事务提交，但是Buffer pool的的脏页未刷盘，则需要通过Redo日志来进行恢复数据。事务未提交，但是Buffer pool的的脏页刷盘，则需要通过Undo来实现，Undo 又是通过 Redo 来保证的，所以最终原子性的保证还是靠 Redo 的 WAL 机制实现的。

### 持久性

一旦事务提交，它对数据库中数据的改变是**永久的**，接下来的操作和故障都不应该对其有影响。首先的事务的原子性会保证这一系列操作一定是全部成功或者全部失败。所以即便是宕机了，也可以从逻辑上将数据全部找到再次写入存储空间

### 隔离性

事务内部的操作及使用的数据对其他的并发事务是隔离的。**锁和多版本控制**就符合隔离性。

### 并发事务控制

+ gap锁（间隙锁）：实质是对索引前后的间隙上锁，不对索引上锁。根据检索条件向左寻找最靠近检索条件的记录值A，作为左区间，向右寻找最靠近检索条件的记录值B作为右区间，即锁定的间隙为（A，B），间隙锁的目的是为了防止幻读
+ row锁