# SpringCloud alibaba

后续SpringCloud alibaba写成sca

## 为什么微服务必须要有注册中心

### 注册中心的原理

类似于MQ

涉及到三大角色：

+ 服务提供者
+ 服务消费者
+ 注册中心

关系大致如下：

+ 服务在启动时将服务注册到注册中心，注册中心存储数据
+ 服务消费者从注册中心查询服务可用的服务及地址，并且通过地址调用服务者接口
+ 通过类似心跳检测去检测服务是否可用，如果长时间不可用则注销服务
+ 服务地址发生变化时会重新注册，不需要人工干预去修改地址

### 注册中心的功能

1. 服务注册表

   核心：记录各个服务信息，例如IP、端口。提供查询API和管理API，查询API可用的微服务实例，管理API用于服务的注册与注销

2. 服务注册与发现

   服务在启动时，将自己的信息注册到服务中心，服务发现是查询可用的微服务列表以及网络地址

3. 服务检查

   类似于心跳检测，如果长时间不能检测，则注销服务

## 注册中心的选型

A：可用性

C：一致性，保证各个节点的数据一致性

P：分区容错性

### Zookeeper

原理：**leader+follower**，leader写，同步到follower，follower可读，保证**顺序一致性**，就是基本尽量保证数据一致性，主动推送，典型的CP（尽可能保证每个节点上的数据是一致性的），leader崩溃的时候，为了保证数据的一致性，此时要重选leader以及做数据同步，此时服务不可用（CP），保证了数据一致性后，再让服务可用

在同步数据期间，可能会有及其短暂的服务不一致的情况，但是最终会服务数据一致

### Eureka

原理：**peer-to-peer**，大家都能读也都能写，每个节点都要同步给其它节点，但是是异步复制的（同步性不高），所以随时读任何一个节点，可能读到的数据不一样，任何一个节点宕机，其余的节点都可以正常使用，可用性超高，但是数据一致性不行，典型的AP

### Consul

原理：基于raft算法实现的CP

### Nacos

原理：基于raft算法实现的CP，但是可以配置成类似于eureka的AP

### 总结：

其实CP或者AP都可行，CP偶尔段时间不可用，AP可能会出现数据不一致性。但是其中nacos的功能最完善，包含了雪崩保护，自动注销实例，监听支持，多数据中心，跨注册中心同步，spring cloud集成，dubbo集成，k8s集成，这些都支持，其余的只支持部分。更建议CP。

## sca Nacos注册中心的原理

服务通过nacos server内部的open api 进行服务注册，nacos server内部有一个service服务的概念，里面有多个instance实例的概念，同时对**不同的service服务可以划归到不同的namespace命名空间下去**

注册的时候就是在注册表里维护每个服务的每个**实例服务的IP、端口**，这是最关键的

一旦注册成功后，服务就会跟nacos server进行**定时的心跳连接**，nacos server会定时检测各个实例服务的心跳，如果一定时间没有心跳，则会**注销服务**

其它服务会从nacos server通过open api查询要调用的服务实例列表，而且nacos客户端会启动一个**定时任务**，每隔10S就**重新拉取一次服务实例列表**，如果调用的服务有上线或者下线，就能很快感知到

如果出现服务异常，nacos server会向客户端进行推送服务异常信息

## Nacos服务注册中心的内核原理

自动装配：系统启动的时候，自动装配机制会自动运行，实现一些系统的初始化、自动化的事

Nacos本身可以单独运作，但是目前是集成到sca里，也就是在spring cloud的标准下实现了一些东西，spring cloud自己有一个接口，叫**ServiceRegistry**(服务注册中心)

Nacos是实现了这个接口，也就是**NacosServiceRegistry**，实现了register、deregister、close、setStatus、getStatus之类的方法

在服务启动时，会**自动装配调用register方法进行服务注册，还会通过schedule调用线程池去提交一个定时任务，进行心跳发送给nacos server**

注册时访问nacos server的open api，也就是访问http://nacosip:port/nacos/v1/instance?serviceName=xx&ip=xx&port=xx

nacos server是基于一个**ConcurrentHashMap**作为注册表来放服务信息的，直接会构造一个service放到map里，然后对Service去addInstance添加一个实例，本质就是在维护信息，同时**建立定时检查实例心跳的机制**

最后还会基于一致性协议，比如说raft协议，去注册**同步给其它节点**

## Nacos高可用集群部署注意点



